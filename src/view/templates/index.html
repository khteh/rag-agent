{% extends "base.html" %}
{% block content %}
<div class="container" style="margin-top: 10px">
  <div id="chat-room-widget" style="margin-top: 10px">
    <div id="msgs-container">
      <ul id="messages"></ul>
    </div>
    <form id="chatForm" name="chatForm" action="{{url_for('home.invoke')}}" method="post" enctype="multipart/form-data">
      <div id="message-box">
        <input type="text" id="prompt" name="message" placeholder='How can I help?' class="form-control" required onkeyup="stoppedTyping()"/>
        <input id='image', name="image", type='file', accept="image/*"/>
        <button type="submit" id="btn-submit" class="btn btn-primary">Submit</button>
      </div>
    </form>
  </div>
  <script type="text/javascript">
    <!-- https://thepythoncode.com/article/how-to-build-a-chat-app-in-python-using-flask-and-flasksocketio -->
    function stoppedTyping() {
        var value = document.forms["chatForm"]["message"].value;
        //console.log(`stoppedTyping value: ${value}, length: ${value.length}`)
        if(value.length > 0) { 
            $('#btn-submit').removeClass('disabled');
        } else { 
            $('#btn-submit').addClass('disabled');
        }
    }
    document.querySelector("#prompt").onblur = stoppedTyping();
    // Select your input type file and store it in a variable
    document.querySelector("#chatForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const prompt = document.querySelector("#prompt").value;
      const image = document.querySelector("#image");
      //console.log(`btn-submit clicked. prompt: ${prompt}`)
      if (prompt.trim()) {
        var form = new FormData();
        form.append("prompt", prompt);
        if (image && image.files.length && image.files[0]) {
          //console.log(`Image name: ${image.files[0].name}, size: ${image.files[0].size}, type: ${image.files[0].type}`);
          form.append("image", image.files[0]);
        }// else 
          //console.log("No file selected!");
        // Display the key/value pairs
        /*for (var pair of form.entries()) {
            console.log(pair[0]+ ', ' + pair[1]); 
        }*/
        $("prompt").prop('disabled', true);
        $("image").prop('disabled', true);
        $('#btn-submit').addClass('disabled');
        $("#btn-submit").text('Processing...');
        //$(this).text('Read More');
        const response = await fetch('/invoke', {
          method: 'POST',
          //headers: { 'Content-Type': 'multipart/form-data' }, Do NOT declare Content-Type: multipart/form-data in request header
          body: form
        });
        const data = await response.json();
        console.log(JSON.stringify(data, null, 2))
        const queryContainer = document.createElement('div');
        queryContainer.innerHTML = `<div><strong>You:</strong> ${prompt}</div>`;
        document.querySelector("#messages").appendChild(queryContainer);
        //$("#messages").innerHTML += `<div><strong>You:</strong> ${prompt}</div>`;
        var converter = new showdown.Converter();
        const responseContainer = document.createElement('div');
        responseContainer.innerHTML = `<strong>LLM-RAG-Agent:</strong><div>${converter.makeHtml(data.message)}</div><br>`;
        document.querySelector("#messages").appendChild(responseContainer);
        //$("#messages").innerHTML += `<div><strong>Gemini:</strong></div>${converter.makeHtml(data.message)}<br>`;
        $("#prompt").value = '';
        $("#image").value = '';
        $("#submit").text('Submit');
        $("prompt").prop('disabled', false);
        $("image").prop('disabled', false);
      } else 
        console.error(`Invalid prompt!`);
    });
  </script>
</div>
{% endblock %}